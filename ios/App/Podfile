

platform :ios, '14.0'

# Find the node_modules directory by searching upward from the current directory
def find_node_modules_path
  current_dir = __dir__
  while current_dir != '/'
    node_modules_path = File.join(current_dir, 'node_modules')
    if Dir.exist?(node_modules_path)
      return File.join(node_modules_path, '@capacitor/ios/scripts/pods_helpers')
    end
    current_dir = File.dirname(current_dir)
  end
  
  # Fallback paths to try
  fallback_paths = [
    '../../node_modules/@capacitor/ios/scripts/pods_helpers',
    '../../../node_modules/@capacitor/ios/scripts/pods_helpers',
    '../../../../node_modules/@capacitor/ios/scripts/pods_helpers',
    '../../../../../node_modules/@capacitor/ios/scripts/pods_helpers'
  ]
  
  fallback_paths.each do |path|
    full_path = File.expand_path(path, __dir__)
    return path if File.exist?(full_path)
  end
  
  raise "Could not find @capacitor/ios/scripts/pods_helpers"
end

require_relative find_node_modules_path

target 'App' do
  capacitor_pods
  # Add your other dependencies here
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  # Clean up any .DS_Store files that might interfere with code signing
  system("find #{installer.sandbox.root} -name '.DS_Store' -type f -delete")
  
  # Disable code signing for all targets
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['CODE_SIGN_IDENTITY'] = ''
      config.build_settings['DEVELOPMENT_TEAM'] = ''
      config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
      config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
      config.build_settings['PROVISIONING_PROFILE'] = ''
      config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
      config.build_settings['EXPANDED_CODE_SIGN_IDENTITY_NAME'] = ''
      config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
      
      # Additional settings to prevent code signing issues
      config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
      config.build_settings['VALID_ARCHS'] = 'arm64 x86_64'
    end
  end
  
  # Also disable for the main project and all generated projects
  installer.generated_projects.each do |project|
    project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
        config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
        config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
        config.build_settings['CODE_SIGN_IDENTITY'] = ''
        config.build_settings['DEVELOPMENT_TEAM'] = ''
        config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
        config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
        config.build_settings['PROVISIONING_PROFILE'] = ''
        config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
        config.build_settings['EXPANDED_CODE_SIGN_IDENTITY_NAME'] = ''
        config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
      end
    end
  end
  
  # Specifically target the main App project
  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_build_configurations.each do |config_name, config_file|
      xcconfig_path = aggregate_target.client_root + aggregate_target.xcconfig_relative_path(config_name)
      xcconfig = File.read(xcconfig_path)
      xcconfig_mod = xcconfig.gsub(/DT_TOOLCHAIN_DIR/, "TOOLCHAIN_DIR")
      File.open(xcconfig_path, "w") { |file| file << xcconfig_mod }
    end
  end
end

