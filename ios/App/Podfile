
platform :ios, '14.0'

require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

target 'App' do
  capacitor_pods
  # Add your other dependencies here
end

post_install do |installer|
  assertDeploymentTarget(installer)
  
  # Clean up any .DS_Store files that might interfere with code signing
  system("find #{installer.sandbox.root} -name '.DS_Store' -type f -delete")
  
  # Disable code signing for all targets
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
      config.build_settings['CODE_SIGN_IDENTITY'] = ''
      config.build_settings['DEVELOPMENT_TEAM'] = ''
      config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
      config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
      config.build_settings['PROVISIONING_PROFILE'] = ''
      config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
      config.build_settings['EXPANDED_CODE_SIGN_IDENTITY_NAME'] = ''
      config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
      
      # Additional sandboxing fixes
      config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
      config.build_settings['VALID_ARCHS'] = 'arm64 x86_64'
    end
  end
  
  # Also disable sandboxing for the main project
  installer.generated_projects.each do |project|
    project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
        config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
        config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
        config.build_settings['CODE_SIGN_IDENTITY'] = ''
        config.build_settings['DEVELOPMENT_TEAM'] = ''
        config.build_settings['CODE_SIGN_ENTITLEMENTS'] = ''
        config.build_settings['PROVISIONING_PROFILE_SPECIFIER'] = ''
        config.build_settings['PROVISIONING_PROFILE'] = ''
        config.build_settings['EXPANDED_CODE_SIGN_IDENTITY'] = ''
        config.build_settings['EXPANDED_CODE_SIGN_IDENTITY_NAME'] = ''
        config.build_settings['CODE_SIGN_STYLE'] = 'Manual'
      end
    end
  end
  
  # Fix for Xcode 14+ sandboxing issues
  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_build_configurations.each do |config_name, config_file|
      xcconfig_path = aggregate_target.client_root + aggregate_target.xcconfig_relative_path(config_name)
      xcconfig = File.read(xcconfig_path)
      xcconfig_mod = xcconfig.gsub(/DT_TOOLCHAIN_DIR/, "TOOLCHAIN_DIR")
      File.open(xcconfig_path, "w") { |file| file << xcconfig_mod }
    end
  end
end
